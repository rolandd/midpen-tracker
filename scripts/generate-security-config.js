import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Paths
// scripts/ is where this file lives.
// Root is ../
const ROOT_DIR = path.resolve(__dirname, '../');
const POLICY_FILE = path.join(ROOT_DIR, 'permissions-policy.txt');
const OUTPUT_FILE = path.join(ROOT_DIR, 'web/functions/security-config.ts');

try {
	console.log(`Reading Permissions Policy from: ${POLICY_FILE}`);
	const policy = fs.readFileSync(POLICY_FILE, 'utf8').trim();

	if (!policy) {
		throw new Error('permissions-policy.txt is empty');
	}

	// Format to match Prettier default: single quotes, trailing newline
	// Prettier might wrap long lines, so we try to approximate it or just let the user run format
	// But since this is CI, we should try to match the expected format.
	// The failure log showed: Code style issues found in the above file. Run Prettier with --write to fix.

	// We will format it exactly as Prettier wants it.
	const content = `// Auto-generated by scripts/generate-security-config.js
// Do not edit directly. Source: permissions-policy.txt

export const PERMISSIONS_POLICY =
	'${policy}';
`;

	console.log(`Writing to: ${OUTPUT_FILE}`);
	fs.writeFileSync(OUTPUT_FILE, content);
	console.log('Successfully generated security configuration.');
} catch (error) {
	console.error('Failed to generate security configuration:', error);
	process.exit(1);
}
